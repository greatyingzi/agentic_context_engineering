name: Cross-Platform Compatibility Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run tests weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  validate-cross-platform:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          # Exclude some combinations to reduce CI load
          - os: windows-latest
            python-version: '3.11'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install
        python -m pip install --upgrade pip
        pip install unittest

    - name: Run cross-platform validation
      run: |
        python scripts/cross_platform_validator.py
      env:
        # Set environment variables for testing
        AGENTIC_CONTEXT_API_KEY: ${{ secrets.AGENTIC_CONTEXT_API_KEY || 'test-key' }}
        AGENTIC_CONTEXT_MODEL: claude-3-5-sonnet-20241022

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
        path: test_reports/

  windows-specific-validation:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install
        python -m pip install --upgrade pip
        pip install unittest

    - name: Test Windows-specific fixes
      run: |
        # Test Windows path handling
        python -c "
        import os
        print('Testing Windows paths...')

        # Test Python executable detection
        import subprocess
        result = subprocess.run(['python', '--version'], capture_output=True, text=True)
        print(f'Python version: {result.stdout.strip()}')

        # Test PowerShell execution policy check
        import platform
        if platform.system() == 'Windows':
            print('Windows platform detected')
            print('Checking execution policy...')
            result = subprocess.run(['powershell', 'Get-ExecutionPolicy'], capture_output=True, text=True)
            print(f'Current execution policy: {result.stdout.strip()}')
        "

    - name: Run Windows validation
      run: |
        python scripts/cross_platform_validator.py
      env:
        AGENTIC_CONTEXT_API_KEY: ${{ secrets.AGENTIC_CONTEXT_API_KEY || 'test-key' }}

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan.sarif'

    - name: Check for sensitive data
      run: |
        # Check for hardcoded secrets or API keys
        grep -r "api[_-]key\|secret\|token" --include="*.js" --include="*.py" --include="*.json" . || true
        echo "No hardcoded secrets found"

  compatibility-matrix:
    runs-on: ubuntu-latest
    needs: [validate-cross-platform, windows-specific-validation]
    steps:
    - uses: actions/checkout@v4

    - name: Generate compatibility matrix
      run: |
        python -c "
        import json
        from pathlib import Path

        # Collect test results
        results = {}
        for report_path in Path('test_reports').glob('*.md'):
            with open(report_path, 'r') as f:
                content = f.read()
                # Extract platform info and test results
                results[report_path.stem] = {
                    'status': 'PASS' if 'All tests passed' in content else 'FAIL',
                    'platform': 'Unknown'
                }

        # Generate matrix
        matrix = {
            'platforms': ['darwin', 'linux', 'win32'],
            'python_versions': ['3.9', '3.10', '3.11'],
            'results': results
        }

        with open('compatibility_matrix.json', 'w') as f:
            json.dump(matrix, f, indent=2)

        print('Compatibility matrix generated:')
        print(json.dumps(matrix, indent=2))
        "

    - name: Upload compatibility matrix
      uses: actions/upload-artifact@v3
      with:
        name: compatibility-matrix
        path: |
          compatibility_matrix.json
          test_reports/

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [validate-cross-platform, windows-specific-validation, compatibility-matrix]
    if: failure()
    steps:
    - name: Send failure notification
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: 'Cross-platform compatibility tests failed! Please check the results.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}